## **Тема: LINQ-запросы в приложениях C\#**

### **1\. Постановка задачи**

Разработать консольное приложение с дружественным интерфейсом для работы с базой данных. Приложение должно поддерживать чтение и запись данных в Excel, добавление и удаление записей, а также выполнение выборки данных с использованием технологии LINQ (Language Integrated Query).

**Требования к функционалу:**

1. Чтение базы данных из Excel файла.  
2. Просмотр содержимого базы данных.  
3. Удаление и добавление элементов.  
4. Сохранение изменений в файл.  
5. Реализация специфических LINQ-запросов:  
   * Запрос к одной таблице.  
   * Запрос к двум таблицам.  
   * Два запроса к трем таблицам.

### **2\. Описание базы данных**

1. **Художники (Artist)**  
   * ID (Уникальный идентификатор)  
   * Name (Имя и фамилия мастера)  
2. **Стили (Style)**  
   * ID (Уникальный идентификатор)  
   * Name (Название стиля живописи)  
3. **Картины (Painting)**  
   * ID (Уникальный идентификатор)  
   * Name (Название картины)  
   * ArtistId (Внешний ключ к таблице Художников)  
   * StyleId (Внешний ключ к таблице Стилей)  
   * Year (Год создания)  
   * PartOfHermitage (Номер части Эрмитажа, где находится картина)

### **3\. Архитектура приложения**

* **Artist, Style, Painting**: Классы, описывающие структуру данных.  
* **FileProvider**: Класс, отвечающий за взаимодействие с файловой системой. Используется библиотека **ClosedXML** для работы с форматом .xlsx. Данные сохраняются на трех отдельных листах ("Artists", "Styles", "Paintings") в одном файле.  
* **HermitageService**: Класс, содержащий реализацию всех LINQ-запросов и других базовых методов. Хранит списки данных(List) во время работы программы.  
* **Program**: Точка входа, реализующая консольное меню и взаимодействие с пользователем.  
* **CheckInput**: Вспомогательный класс для валидации пользовательского ввода.

### **4\. Реализация LINQ-запросов**

#### **4.1. Запрос с обращением к одной таблице**

**Задача**: Получить список всех картин, находящихся в указанной части Эрмитажа.  
**Реализация**:  
*public List\<string\> Query1\_GetPaintingsInPart(int part)*  
*{*  
    *return \_paintings*  
        *.Where(p \=\> p.PartOfHermitage \== part)*  
        *.Select(p \=\> p.ToString())*  
        *.ToList();*  
*}*

#### **4.2. Запрос с обращением к двум таблицам**

**Задача**: Найти картины определенного художника (поиск по имени или части имени).  
**Реализация**: 

*public List\<string\> Query2\_GetPaintingsByArtist(string artistName)*  
*{*  
    *return \_paintings*  
        *.Join(\_artists,*  
              *p \=\> p.ArtistId,*  
              *a \=\> a.Id,*  
              *(p, a) \=\> new { Painting \= p, Artist \= a })*  
        *.Where(x \=\> x.Artist.Name.Contains(artistName, StringComparison.OrdinalIgnoreCase))*  
        *.Select(x \=\> x.Painting.ToString())*  
        *.ToList();*  
*}*

P.S: Используется метод Join для соединения таблиц Paintings и Artists.

#### **4.3. Запросы с обращением к трем таблицам**

А) Запрос, возвращающий значение

**Задача**: Определить количество художников, у которых более minCount картин расположено в части part Эрмитажа.  
**Реализация**: 

*public int Query3\_CountArtistsWithPaintingsInPart(int minCount, int part)*  
*{*  
    *return \_artists*  
        *.GroupJoin(\_paintings,*  
                   *a \=\> a.Id,*  
                   *p \=\> p.ArtistId,*  
                   *(a, paints) \=\> new { Artist \= a, Count \= paints.Count(p \=\> p.PartOfHermitage \== part) })*  
        *.Count(x \=\> x.Count \> minCount);*  
*}*

P.S: Используется GroupJoin для группировки картин по художникам и последующая фильтрация.

Б) Запрос, возвращающий перечень данных

**Задача**: Вывести полную информацию о самой старой картине (Название, Год, Имя художника, Название стиля).  
**Реализация**: 

*public string Query4\_OldestPaintingInfo()*  
*{*  
    *var data \= \_paintings*  
        *.Join(\_artists, p \=\> p.ArtistId, a \=\> a.Id, (p, a) \=\> new { p, a })*  
        *.Join(\_styles, x \=\> x.p.StyleId, s \=\> s.Id, (x, s) \=\> new { x.p, x.a, s })*  
        *.OrderBy(x \=\> x.p.Year)*  
        .FirstOrDefault();
    if (data == null) return "Нет данных.";
    return $"Самая старая картина: \"{data.p.Name}\" ({data.p.Year}),
           "Художник: {data.a.Name}, Стиль: {data.s.Name}";  
*}*

P.S: Двойной Join для связывания Paintings с Artists, а затем результата со Style. Сортировка OrderBy по году.

### **5\. Работа с Excel (FileProvider)**

Для работы с файлами выбрана библиотека **ClosedXML**.

**Чтение данных**:

Метод **LoadData** проверяет наличие файла. Если файл существует, он открывает XLWorkbook и считывает данные с соответствующих листов (Worksheets), пропуская заголовок (первую строку).  
**Запись данных:**  
Метод **SaveData** создает новую книгу Excel. Для каждой коллекции (Artists, Styles, Paintings) создается отдельный лист. В первую строку записываются заголовки столбцов, далее в цикле заполняются данные.

### **6\. Консольное меню**

При запуске программы пользователю отображается меню:

1. **Просмотр данных:** Выводит все таблицы на экран.  
2. **Добавление данных:** Позволяет добавить нового художника, стиль или картину. При добавлении картины производится проверка существования ID художника и стиля.  
3. **Удаление данных:** Удаление картины по ID.  
4. **Выполнение запросов:** Пункты 6-9 запускают соответствующие LINQ-запросы. Результат выводится в консоль.  
5. **Сохранение:** Записывает текущее состояние базы данных в файл LR5-var11.xlsx.

**Пример работы меню:**

\--- Меню базы данных Эрмитажа \---  
1\. Просмотр всех данных  
...  
6\. Запрос 1: Картины в определенной части музея  
...  
Выберите действие: 6  
Введите номер части Эрмитажа: 2  
Найдено 3 картин:  
ID: 1 | Название: Даная | Год: 1636 | Часть Эрмитажа: 2  
...

**Работу выполнил:** Рычагов Павел Ит-12
